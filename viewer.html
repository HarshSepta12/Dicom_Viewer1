<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Modern DICOM Viewer</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="./css/styles.css" />
    <link
      rel="shortcut icon"
      href="./assets/dicomLogo.png"
      type="image/x-icon"
    />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

    <script src="./js/hammer.js"></script>
    <script src="./js/dicomParser.min.js"></script>
    <script src="./js/cornerstone-core.js"></script>
    <script src="./js/cornerstone-math.js"></script>
    <script src="./js/cornerstone-wado-image-loader.js"></script>
    <script src="./js/cornerstone-tools.js"></script>
    <!-- <script src="https://unpkg.com/@cornerstonejs/core?module"></script> -->
  </head>
  <body>
    <div class="app-header">
      <div class="app-logo">D</div>
      <div class="app-title">DICOM Viewer with Cine</div>
    </div>

    <div class="main-container">
      <div class="sidebar">
        <div class="sidebar-section">
          <div class="progress-bar" id="uploadProgress" style="display: none">
            <div class="progress-fill" id="progressFill"></div>
          </div>

          <div class="error-message" id="errorMessage"></div>
          <div class="success-message" id="successMessage"></div>
        </div>
        <div
          class="sidebar-section"
          style="flex: 1; display: flex; flex-direction: column; min-height: 0"
        >
          <div class="sidebar-title">Series</div>
          <div class="series-container" id="seriesContainer">
            <!-- Series will be added here -->
          </div>
        </div>
      </div>

      <div class="viewer-area">
        <div class="toolbar">
          <div class="tool-group">
            <button class="tool-btn" id="annotationTool" title="Annotations">
              <i class="fas fa-pen"></i>
            </button>
            <div class="tool-dropdown" id="annotationDropdown">
              <div
                class="dropdown-item"
                onclick="activateTool('bidirectional')"
              >
                <i class="fas fa-arrows-alt"></i> Bidirectional
              </div>
              <div class="dropdown-item" onclick="activateTool('arrow')">
                <i class="fas fa-long-arrow-alt-right"></i> Arrow
              </div>
              <div class="dropdown-item" onclick="activateTool('ellipse')">
                <i class="fas fa-circle"></i> Ellipse ROI
              </div>
              <div class="dropdown-item" onclick="activateTool('rectangle')">
                <i class="fas fa-square"></i> Rectangle ROI
              </div>
              <div class="dropdown-item" onclick="activateTool('freehand')">
                <i class="fas fa-pencil-alt"></i> Freehand
              </div>
              <div class="dropdown-item" onclick="activateTool('length')">
                <i class="fas fa-ruler"></i> Length
              </div>
              <div class="dropdown-item" onclick="activateTool('angle')">
                <i class="fas fa-drafting-compass"></i> Angle
              </div>
              <div class="dropdown-item" onclick="activateTool('probe')">
                <i class="fas fa-crosshairs"></i> Probe
              </div>

              <div
                class="dropdown-item"
                class="tool-btn"
                id="dicomTagTool"
                title="DICOM Tags"
                onclick="showDicomTags()"
              >
                <i class="fas fa-tags"></i>
                DICOM Tags
              </div>
            </div>
          </div>

          <div class="tool-group">
            <button
              class="tool-btn active"
              id="wwwcTool"
              onclick="activateTool('wwwc')"
              title="Window/Level"
            >
              <i class="fas fa-adjust"></i>
            </button>
            <button
              class="tool-btn"
              onclick="activateTool('zoom')"
              title="Zoom"
            >
              <i class="fas fa-search-plus"></i>
            </button>
            <button class="tool-btn" onclick="activateTool('pan')" title="Pan">
              <i class="fas fa-hand-paper"></i>
            </button>
            <button
              class="tool-btn"
              onclick="activateTool('magnify')"
              title="Magnify"
            >
              <i class="fas fa-search"></i>
            </button>
          </div>

          <div class="tool-group">
            <button class="tool-btn" onclick="invertImage()" title="Invert">
              <i class="fas fa-adjust"></i>
            </button>
            <button class="tool-btn" onclick="resetViewport()" title="Reset">
              <i class="fas fa-redo"></i>
            </button>
            <button
              class="tool-btn"
              onclick="activateTool('eraser')"
              title="Eraser"
            >
              <i class="fas fa-eraser"></i>
            </button>
          </div>

          <div class="tool-group">
            <button class="tool-btn" id="layoutTool" title="Layout">
              <i class="fas fa-th"></i>
            </button>
            <div class="tool-dropdown" id="layoutDropdown">
              <div class="dropdown-item" onclick="changeLayout('1x1')">
                <i class="fas fa-square"></i> 1x1
              </div>
              <div class="dropdown-item" onclick="changeLayout('1x2')">
                <i class="fas fa-columns"></i> 1x2
              </div>
              <div class="dropdown-item" onclick="changeLayout('2x1')">
                <i class="fas fa-grip-lines"></i> 2x1
              </div>
              <div class="dropdown-item" onclick="changeLayout('2x2')">
                <i class="fas fa-th"></i> 2x2
              </div>
            </div>
          </div>
          <div class="tool-group">
            <button class="tool-btn" id="mprTool" title="MPR View">
              <i class="fas fa-cubes"></i>
            </button>
          </div>

          <div class="preset-buttons">
            <button class="preset-btn" onclick="applyPreset('soft')">
              Soft Tissue
            </button>
            <button class="preset-btn" onclick="applyPreset('bone')">
              Bone
            </button>
            <button class="preset-btn" onclick="applyPreset('lung')">
              Lung
            </button>
            <button class="preset-btn" onclick="applyPreset('brain')">
              Brain
            </button>
          </div>
        </div>

        <div class="dicom-viewport" id="viewport">
          <!-- DICOM Tag Modal -->
          <div
            class="modal fade"
            id="dicomTagModal"
            tabindex="-1"
            role="dialog"
            aria-labelledby="dicomTagModalLabel"
            aria-hidden="true"
          >
            <div class="modal-dialog modal-lg" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="dicomTagModalLabel">
                    <i class="fas fa-tags"></i> DICOM Tags Information
                  </h5>
                  <button
                    type="button"
                    class="close"
                    data-dismiss="modal"
                    aria-label="Close"
                  >
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body" id="dicomTagContent">
                  <!-- DICOM tags content will be populated here -->
                  <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                      <span class="sr-only">Loading...</span>
                    </div>
                    <p class="mt-2">Loading DICOM tags...</p>
                  </div>
                </div>
                <div class="modal-footer">
                  <button
                    type="button"
                    class="btn btn-secondary"
                    data-dismiss="modal"
                  >
                    <i class="fas fa-times"></i> Close
                  </button>
                  <button
                    type="button"
                    class="btn btn-primary"
                    onclick="exportDicomTags()"
                  >
                    <i class="fas fa-download"></i> Export Tags
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- <div class="empty-state" id="emptyState">
            <div class="empty-icon">
              <i class="fas fa-file-medical"></i>
            </div>
            <div>Upload DICOM files to begin viewing</div>
          </div> -->

          <div id="viewportContainer" style="width: 100%; height: 100%">
            <div
              id="dicomImage"
              class="dicom-viewport"
              style="width: 100%; height: 100%"
            ></div>
          </div>

          <div
            id="mprContainer"
            style="
              display: none;
              width: 100%;
              height: 100%;
              grid-template-rows: auto 1fr;
              gap: 5px;
              background: #0b1426;
            "
          >
            <!-- MPR Controls Header -->
            <div
              class="mpr-controls"
              style="
                background: rgba(26, 35, 50, 0.95);
                padding: 10px 20px;
                border-bottom: 1px solid #374151;
                display: flex;
                align-items: center;
                justify-content: space-between;
                flex-wrap: wrap;
                gap: 15px;
                z-index: 15;
              "
            >
              <!-- MPR Title and Info -->
              <div
                class="mpr-info"
                style="display: flex; align-items: center; gap: 15px"
              >
                <h3
                  style="
                    color: #e5e7eb;
                    margin: 0;
                    font-size: 16px;
                    font-weight: 600;
                  "
                >
                  <i
                    class="fas fa-cubes"
                    style="color: #3b82f6; margin-right: 8px"
                  ></i>
                  Multi-Planar Reconstruction
                </h3>
                <div
                  class="mpr-position"
                  id="mprPosition"
                  style="
                    color: #9ca3af;
                    font-size: 12px;
                    font-family: monospace;
                    background: rgba(55, 65, 81, 0.5);
                    padding: 4px 8px;
                    border-radius: 4px;
                  "
                >
                  Position: (0.5, 0.5, 0.5)
                </div>
              </div>

              <!-- MPR Navigation Controls -->
              <div
                class="mpr-navigation"
                style="display: flex; align-items: center; gap: 10px"
              >
                <!-- Crosshair Reset Button -->
                <button
                  class="mpr-btn"
                  id="mprResetBtn"
                  title="Reset Crosshair to Center"
                  style="
                    background: rgba(75, 85, 99, 0.8);
                    border: 1px solid #6b7280;
                    color: #e5e7eb;
                    padding: 6px 12px;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 11px;
                    transition: all 0.2s;
                  "
                >
                  <i class="fas fa-crosshairs"></i> Reset
                </button>

                <!-- Sync Window/Level Toggle -->
                <button
                  class="mpr-btn"
                  id="mprSyncBtn"
                  title="Synchronize Window/Level"
                  style="
                    background: rgba(59, 130, 246, 0.8);
                    border: 1px solid #3b82f6;
                    color: white;
                    padding: 6px 12px;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 11px;
                    transition: all 0.2s;
                  "
                >
                  <i class="fas fa-sync"></i> Sync W/L
                </button>

                <!-- Exit MPR Button -->
                <button
                  class="mpr-btn"
                  id="mprExitBtn"
                  title="Exit MPR Mode"
                  style="
                    background: rgba(239, 68, 68, 0.8);
                    border: 1px solid #ef4444;
                    color: white;
                    padding: 6px 12px;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 11px;
                    transition: all 0.2s;
                  "
                >
                  <i class="fas fa-times"></i> Exit MPR
                </button>
              </div>

              <!-- Keyboard Shortcuts Info -->
              <div
                class="mpr-shortcuts"
                style="
                  color: #6b7280;
                  font-size: 10px;
                  text-align: right;
                  line-height: 1.3;
                "
              >
                <div>
                  <strong>Controls:</strong> WASD (crosshair), QE (slice), ESC
                  (exit)
                </div>
                <div>Click on any view to move crosshair</div>
              </div>
            </div>

            <!-- MPR Viewports Grid -->
            <div
              class="mpr-grid"
              style="
                display: grid;
                grid-template-columns: 1fr 1fr 1fr;
                gap: 2px;
                height: 100%;
                background: #000;
              "
            >
              <!-- Axial Viewport -->
              <div
                class="mpr-viewport-container"
                style="position: relative; background: #000"
              >
                <div
                  id="mprAxial"
                  class="dicom-viewport mpr-viewport"
                  style="
                    width: 100%;
                    height: 100%;
                    border: 2px solid #374151;
                    transition: border-color 0.2s;
                  "
                ></div>

                <!-- Axial Overlay Info -->
                <div
                  class="mpr-overlay-info"
                  style="
                    position: absolute;
                    top: 35px;
                    left: 10px;
                    color: #fbbf24;
                    font-size: 11px;
                    font-family: monospace;
                    background: rgba(0, 0, 0, 0.7);
                    padding: 4px 8px;
                    border-radius: 4px;
                    pointer-events: none;
                    z-index: 20;
                  "
                >
                  <div id="axialSliceInfo">Slice: 1/100</div>
                  <div id="axialOrientationInfo">A-P | R-L</div>
                </div>
              </div>

              <!-- Sagittal Viewport -->
              <div
                class="mpr-viewport-container"
                style="position: relative; background: #000"
              >
                <div
                  id="mprSagittal"
                  class="dicom-viewport mpr-viewport"
                  style="
                    width: 100%;
                    height: 100%;
                    border: 2px solid #374151;
                    transition: border-color 0.2s;
                  "
                ></div>

                <!-- Sagittal Overlay Info -->
                <div
                  class="mpr-overlay-info"
                  style="
                    position: absolute;
                    top: 35px;
                    left: 10px;
                    color: #fbbf24;
                    font-size: 11px;
                    font-family: monospace;
                    background: rgba(0, 0, 0, 0.7);
                    padding: 4px 8px;
                    border-radius: 4px;
                    pointer-events: none;
                    z-index: 20;
                  "
                >
                  <div id="sagittalSliceInfo">Slice: 1/512</div>
                  <div id="sagittalOrientationInfo">S-I | A-P</div>
                </div>
              </div>

              <!-- Coronal Viewport -->
              <div
                class="mpr-viewport-container"
                style="position: relative; background: #000"
              >
                <div
                  id="mprCoronal"
                  class="dicom-viewport mpr-viewport"
                  style="
                    width: 100%;
                    height: 100%;
                    border: 2px solid #374151;
                    transition: border-color 0.2s;
                  "
                ></div>

                <!-- Coronal Overlay Info -->
                <div
                  class="mpr-overlay-info"
                  style="
                    position: absolute;
                    top: 35px;
                    left: 10px;
                    color: #fbbf24;
                    font-size: 11px;
                    font-family: monospace;
                    background: rgba(0, 0, 0, 0.7);
                    padding: 4px 8px;
                    border-radius: 4px;
                    pointer-events: none;
                    z-index: 20;
                  "
                >
                  <div id="coronalSliceInfo">Slice: 1/512</div>
                  <div id="coronalOrientationInfo">S-I | R-L</div>
                </div>
              </div>
            </div>
          </div>
          <!-- <div id="dicomImage" class="dicom-viewport"></div>
<div id="viewportContainer"></div> -->

          <div class="viewport-overlay viewport-info-tl" id="topLeft">
            Patient: John Doe<br />
            Study: CT Chest
          </div>

          <div class="viewport-overlay viewport-info-tr" id="topRight">
            Date: 2024-01-15<br />
            Time: 14:30:25
          </div>

          <div class="viewport-overlay viewport-info-bl" id="bottomLeft">
            Series: 1/5<br />
            Image: 1/25
          </div>

          <div class="viewport-overlay viewport-info-br" id="bottomRight">
            WW/WC: 400/40<br />
            Zoom: 1.0x
          </div>

          <!-- Cine Controls -->
          <div class="cine-controls" id="cineControls">
            <div class="cine-controls-container">
              <!-- Playback Controls -->
              <div class="cine-buttons">
                <button class="cine-btn" id="firstBtn" title="First Image">
                  <i class="fas fa-step-backward"></i>
                </button>
                <button class="cine-btn" id="prevBtn" title="Previous">
                  <i class="fas fa-chevron-left"></i>
                </button>
                <button
                  class="cine-btn play-pause"
                  id="playPauseBtn"
                  title="Play/Pause"
                >
                  <i class="fas fa-play"></i>
                </button>
                <button class="cine-btn" id="nextBtn" title="Next">
                  <i class="fas fa-chevron-right"></i>
                </button>
                <button class="cine-btn" id="lastBtn" title="Last Image">
                  <i class="fas fa-step-forward"></i>
                </button>
              </div>

              <!-- Progress Bar -->
              <div class="cine-progress-container">
                <div class="cine-time-display" id="currentTime">1 / 25</div>
                <div class="cine-progress" id="progressBar">
                  <div class="cine-progress-fill" id="progressFill"></div>
                  <div class="cine-progress-thumb" id="progressThumb"></div>
                </div>
                <div class="cine-time-display" id="totalTime">25</div>
              </div>

              <!-- Speed Controls -->
              <div class="cine-speed-controls">
                <span class="speed-label">Speed:</span>
                <button class="speed-btn" data-speed="0.25">0.25x</button>
                <button class="speed-btn" data-speed="0.5">0.5x</button>
                <button class="speed-btn active" data-speed="1">1x</button>
                <button class="speed-btn" data-speed="2">2x</button>
                <button class="speed-btn" data-speed="4">4x</button>
                <button
                  class="cine-btn"
                  id="loopBtn"
                  title="Toggle Loop"
                  style="margin-left: 15px"
                >
                  <i class="fas fa-sync-alt"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="status-bar">
      <span id="statusText">Ready</span>
    </div>

    <div class="loading-overlay" id="loadingOverlay" style="display: none">
      <div class="loading-spinner"></div>
      <div id="loadingText">Loading DICOM images...</div>
    </div>
    <!-- DICOM Tag Modal -->
    <div
      class="modal fade"
      id="dicomTagModal"
      tabindex="-1"
      role="dialog"
      aria-hidden="true"
    ></div>

    <script src="./js/script.js"></script>
  </body>
</html>
