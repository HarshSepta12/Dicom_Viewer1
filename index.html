<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Modern DICOM Viewer</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://unpkg.com/hammerjs@2.0.8/hammer.js"></script>
    <script src="https://unpkg.com/dicom-parser@1.8.3/dist/dicomParser.min.js"></script>
    <script src="https://unpkg.com/cornerstone-core"></script>
    <script src="https://unpkg.com/cornerstone-math"></script>
    <script src="https://unpkg.com/cornerstone-wado-image-loader"></script>
    <script src="https://unpkg.com/cornerstone-tools"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #0b1426;
        color: #ffffff;
        height: 100vh;
        overflow: hidden;
      }

      .app-header {
        background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
        height: 60px;
        display: flex;
        align-items: center;
        padding: 0 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        position: relative;
      }

      .app-title {
        font-size: 20px;
        font-weight: 600;
        margin-left: 10px;
      }

      .app-logo {
        width: 32px;
        height: 32px;
        background: #ffffff;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #1e3a8a;
        font-weight: bold;
      }

      .main-container {
        display: flex;
        height: calc(100vh - 60px);
      }

      .sidebar {
        width: 320px;
        background: #1a2332;
        border-right: 1px solid #2d3748;
        display: flex;
        flex-direction: column;
      }

      .sidebar-section {
        padding: 20px;
        border-bottom: 1px solid #2d3748;
      }

      .sidebar-title {
        font-size: 14px;
        color: #a0aec0;
        margin-bottom: 15px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 500;
      }

      .upload-area {
        border: 2px dashed #4a5568;
        border-radius: 8px;
        padding: 30px 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: rgba(74, 85, 104, 0.1);
      }

      .upload-area:hover {
        border-color: #3b82f6;
        background: rgba(59, 130, 246, 0.1);
      }

      .upload-area.dragover {
        border-color: #10b981;
        background: rgba(16, 185, 129, 0.1);
      }

      .upload-icon {
        font-size: 48px;
        color: #4a5568;
        margin-bottom: 15px;
      }

      .upload-text {
        font-size: 16px;
        color: #e2e8f0;
        margin-bottom: 10px;
      }

      .upload-subtext {
        font-size: 12px;
        color: #a0aec0;
      }

      .file-input {
        display: none;
      }

      .upload-buttons {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }

      .upload-btn {
        flex: 1;
        padding: 8px 16px;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        transition: background 0.2s;
      }

      .upload-btn:hover {
        background: #2563eb;
      }

      .upload-btn.secondary {
        background: #374151;
      }

      .upload-btn.secondary:hover {
        background: #4b5563;
      }

      .series-container {
        flex: 1;
        overflow-y: auto;
        padding: 0 10px;
        max-height: calc(100vh - 400px);
      }

      .series-container::-webkit-scrollbar {
        width: 8px;
      }

      .series-container::-webkit-scrollbar-track {
        background: #2d3748;
        border-radius: 4px;
      }

      .series-container::-webkit-scrollbar-thumb {
        background: #4a5568;
        border-radius: 4px;
      }

      .series-container::-webkit-scrollbar-thumb:hover {
        background: #6b7280;
      }

      .series-item {
        background: #2d3748;
        border-radius: 8px;
        margin-bottom: 10px;
        overflow: hidden;
        transition: all 0.2s;
        border: 2px solid transparent;
      }

      .series-item:hover {
        border-color: #3b82f6;
      }

      .series-item.active {
        border-color: #10b981;
        box-shadow: 0 0 10px rgba(16, 185, 129, 0.3);
      }

      .series-header {
        padding: 12px;
        background: #374151;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .series-title {
        font-size: 14px;
        font-weight: 500;
        color: #e5e7eb;
        line-height: 1.2;
      }

      .series-info {
        font-size: 12px;
        color: #9ca3af;
        margin-top: 4px;
      }

      .series-count {
        background: #1f2937;
        color: #9ca3af;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 500;
      }

      .thumbnails-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 8px;
        padding: 12px;
        max-height: 200px;
        overflow-y: auto;
      }

      .thumbnail {
        width: 100%;
        height: 80px;
        border: 2px solid transparent;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
        background: #1f2937;
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .thumbnail:hover {
        border-color: #3b82f6;
      }

      .thumbnail.active {
        border-color: #10b981;
        box-shadow: 0 0 8px rgba(16, 185, 129, 0.3);
      }

      .thumbnail-image {
        width: 100%;
        height: 100%;
        object-fit: contain;
        background: #000000;
        border-radius: 2px;
      }

      .thumbnail-info {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(transparent, rgba(0, 0, 0, 0.9));
        color: white;
        padding: 4px 2px 2px 2px;
        font-size: 9px;
        text-align: center;
        line-height: 1.1;
      }

      .viewer-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #0b1426;
      }

      .toolbar {
        background: #1a2332;
        height: 60px;
        display: flex;
        align-items: center;
        padding: 0 20px;
        gap: 5px;
        border-bottom: 1px solid #2d3748;
        /* overflow-x: auto; */
      }

      .tool-group {
        display: flex;
        gap: 5px;
        margin-right: 20px;
        position: relative;
      }

      .tool-btn {
        width: 44px;
        height: 44px;
        background: #374151;
        border: 1px solid #4b5563;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #e5e7eb;
        font-size: 16px;
        transition: all 0.2s;
        position: relative;
      }

      .tool-btn:hover {
        background: #4b5563;
        border-color: #6b7280;
      }

      .tool-btn.active {
        background: #3b82f6;
        border-color: #2563eb;
        color: white;
      }

      .tool-dropdown {
        position: absolute;
        top: 50px;
        left: 0;
        background: #1f2937;
        border: 1px solid #374151;
        border-radius: 6px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        z-index: 100;
        min-width: 180px;
        display: none;
      }

      .tool-dropdown.show {
        display: block;
      }

      .dropdown-item {
        padding: 12px 16px;
        cursor: pointer;
        border-bottom: 1px solid #374151;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 14px;
      }

      .dropdown-item:hover {
        background: #374151;
      }

      .dropdown-item:last-child {
        border-bottom: none;
      }

      .preset-buttons {
        display: flex;
        gap: 5px;
      }

      .preset-btn {
        padding: 8px 12px;
        background: #374151;
        border: 1px solid #4b5563;
        border-radius: 4px;
        color: #e5e7eb;
        font-size: 11px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .preset-btn:hover {
        background: #4b5563;
      }

      .dicom-viewport {
        flex: 1;
        position: relative;
        background: #000000;
        overflow: hidden;
      }

      .viewport-overlay {
        position: absolute;
        pointer-events: none;
        z-index: 10;
      }

      .viewport-info-tl {
        top: 15px;
        left: 15px;
        color: #fbbf24;
        font-size: 12px;
        font-family: monospace;
      }

      .viewport-info-tr {
        top: 15px;
        right: 15px;
        color: #fbbf24;
        font-size: 12px;
        font-family: monospace;
        text-align: right;
      }

      .viewport-info-bl {
        bottom: 15px;
        left: 15px;
        color: #fbbf24;
        font-size: 12px;
        font-family: monospace;
      }

      .viewport-info-br {
        bottom: 15px;
        right: 15px;
        color: #fbbf24;
        font-size: 12px;
        font-family: monospace;
        text-align: right;
      }

      .status-bar {
        background: #1a2332;
        height: 40px;
        display: flex;
        align-items: center;
        padding: 0 20px;
        border-top: 1px solid #2d3748;
        font-size: 12px;
        color: #a0aec0;
      }

      .progress-bar {
        width: 100%;
        height: 4px;
        background: #374151;
        border-radius: 2px;
        overflow: hidden;
        margin: 10px 0;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #3b82f6, #10b981);
        width: 0%;
        transition: width 0.3s ease;
      }

      .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        z-index: 1000;
      }

      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid #374151;
        border-top: 3px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 15px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .empty-state {
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        height: 100%;
        color: #6b7280;
      }

      .empty-icon {
        font-size: 64px;
        margin-bottom: 20px;
      }

      .error-message {
        background: #dc2626;
        color: white;
        padding: 10px;
        border-radius: 6px;
        margin: 10px 0;
        display: none;
      }

      .success-message {
        background: #059669;
        color: white;
        padding: 10px;
        border-radius: 6px;
        margin: 10px 0;
        display: none;
      }

      .thumbnail-loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #6b7280;
        font-size: 10px;
      }

      .series-collapsed .thumbnails-grid {
        display: none;
      }

      .expand-icon {
        transition: transform 0.2s;
      }

      .series-collapsed .expand-icon {
        transform: rotate(-90deg);
      }
    </style>
  </head>
  <body>
    <div class="app-header">
      <div class="app-logo">D</div>
      <div class="app-title">DICOM Viewer</div>
    </div>

    <div class="main-container">
      <div class="sidebar">
        <div class="sidebar-section">
          <div class="sidebar-title">Upload DICOM Files</div>
          <div class="upload-area" id="uploadArea">
            <div class="upload-icon">
              <i class="fas fa-cloud-upload-alt"></i>
            </div>
            <div class="upload-text">Drop DICOM files here</div>
            <div class="upload-subtext">or click to browse</div>
            <div class="upload-buttons">
              <button
                class="upload-btn"
                onclick="document.getElementById('fileInput').click()"
              >
                <i class="fas fa-file"></i> Files
              </button>
              <button
                class="upload-btn secondary"
                onclick="document.getElementById('folderInput').click()"
              >
                <i class="fas fa-folder"></i> Folder
              </button>
            </div>
          </div>
          <input type="file" id="fileInput" class="file-input" multiple />
          <input
            type="file"
            id="folderInput"
            class="file-input"
            webkitdirectory
            multiple
          />

          <div class="progress-bar" id="uploadProgress" style="display: none">
            <div class="progress-fill" id="progressFill"></div>
          </div>

          <div class="error-message" id="errorMessage"></div>
          <div class="success-message" id="successMessage"></div>
        </div>

        <div
          class="sidebar-section"
          style="flex: 1; display: flex; flex-direction: column; min-height: 0"
        >
          <div class="sidebar-title">Series</div>
          <div class="series-container" id="seriesContainer">
            <!-- Series will be added here -->
          </div>
        </div>
      </div>

      <div class="viewer-area">
        <div class="toolbar">
          <div class="tool-group">
            <button class="tool-btn" id="annotationTool" title="Annotations">
              <i class="fas fa-pen"></i>
            </button>
            <div class="tool-dropdown" id="annotationDropdown">
              <div
                class="dropdown-item"
                onclick="activateTool('bidirectional')"
              >
                <i class="fas fa-arrows-alt"></i> Bidirectional
              </div>
              <div class="dropdown-item" onclick="activateTool('arrow')">
                <i class="fas fa-long-arrow-alt-right"></i> Arrow
              </div>
              <div class="dropdown-item" onclick="activateTool('ellipse')">
                <i class="fas fa-circle"></i> Ellipse ROI
              </div>
              <div class="dropdown-item" onclick="activateTool('rectangle')">
                <i class="fas fa-square"></i> Rectangle ROI
              </div>
              <div class="dropdown-item" onclick="activateTool('freehand')">
                <i class="fas fa-pencil-alt"></i> Freehand
              </div>
              <div class="dropdown-item" onclick="activateTool('length')">
                <i class="fas fa-ruler"></i> Length
              </div>
              <div class="dropdown-item" onclick="activateTool('angle')">
                <i class="fas fa-drafting-compass"></i> Angle
              </div>
              <div class="dropdown-item" onclick="activateTool('probe')">
                <i class="fas fa-crosshairs"></i> Probe
              </div>
            </div>
          </div>

          <div class="tool-group">
            <button
              class="tool-btn active"
              id="wwwcTool"
              onclick="activateTool('wwwc')"
              title="Window/Level"
            >
              <i class="fas fa-adjust"></i>
            </button>
            <button
              class="tool-btn"
              onclick="activateTool('zoom')"
              title="Zoom"
            >
              <i class="fas fa-search-plus"></i>
            </button>
            <button class="tool-btn" onclick="activateTool('pan')" title="Pan">
              <i class="fas fa-hand-paper"></i>
            </button>
            <button
              class="tool-btn"
              onclick="activateTool('magnify')"
              title="Magnify"
            >
              <i class="fas fa-search"></i>
            </button>
          </div>

          <div class="tool-group">
            <button class="tool-btn" onclick="invertImage()" title="Invert">
              <i class="fas fa-adjust"></i>
            </button>
            <button class="tool-btn" onclick="resetViewport()" title="Reset">
              <i class="fas fa-redo"></i>
            </button>
            <button
              class="tool-btn"
              onclick="activateTool('eraser')"
              title="Eraser"
            >
              <i class="fas fa-eraser"></i>
            </button>
          </div>

          <div class="tool-group">
            <button class="tool-btn" id="layoutTool" title="Layout">
              <i class="fas fa-th"></i>
            </button>
            <div class="tool-dropdown" id="layoutDropdown">
              <div class="dropdown-item" onclick="changeLayout('1x1')">
                <i class="fas fa-square"></i> 1x1
              </div>
              <div class="dropdown-item" onclick="changeLayout('1x2')">
                <i class="fas fa-columns"></i> 1x2
              </div>
              <div class="dropdown-item" onclick="changeLayout('2x1')">
                <i class="fas fa-grip-lines"></i> 2x1
              </div>
              <div class="dropdown-item" onclick="changeLayout('2x2')">
                <i class="fas fa-th"></i> 2x2
              </div>
            </div>
          </div>

          <div class="preset-buttons">
            <button class="preset-btn" onclick="applyPreset('soft')">
              Soft Tissue
            </button>
            <button class="preset-btn" onclick="applyPreset('bone')">
              Bone
            </button>
            <button class="preset-btn" onclick="applyPreset('lung')">
              Lung
            </button>
            <button class="preset-btn" onclick="applyPreset('brain')">
              Brain
            </button>
          </div>
        </div>

        <div class="dicom-viewport" id="viewport">
          <div class="empty-state" id="emptyState">
            <div class="empty-icon">
              <i class="fas fa-file-medical"></i>
            </div>
            <div>Upload DICOM files to begin viewing</div>
          </div>

          <div id="viewportContainer" style="width: 100%; height: 100%">
            <div
              id="dicomImage"
              class="dicom-viewport"
              style="width: 100%; height: 100%"
            ></div>
          </div>

          <!-- <div id="dicomImage" style="width: 100%; height: 100%; display: none;"></div> -->

          <div class="viewport-overlay viewport-info-tl" id="topLeft">
            Patient: John Doe<br />
            Study: CT Chest
          </div>

          <div class="viewport-overlay viewport-info-tr" id="topRight">
            Date: 2024-01-15<br />
            Time: 14:30:25
          </div>

          <div class="viewport-overlay viewport-info-bl" id="bottomLeft">
            Series: 1/5<br />
            Image: 1/25
          </div>

          <div class="viewport-overlay viewport-info-br" id="bottomRight">
            WW/WC: 400/40<br />
            Zoom: 1.0x
          </div>
        </div>
      </div>
    </div>

    <div class="status-bar">
      <span id="statusText">Ready</span>
    </div>

    <div class="loading-overlay" id="loadingOverlay" style="display: none">
      <div class="loading-spinner"></div>
      <div id="loadingText">Loading DICOM images...</div>
    </div>

    <script>
      // Initialize Cornerstone
      cornerstoneTools.external.Hammer = Hammer;
      cornerstoneTools.external.cornerstone = cornerstone;
      cornerstoneWADOImageLoader.external.dicomParser = dicomParser;
      cornerstoneWADOImageLoader.external.cornerstone = cornerstone;
      cornerstoneTools.external.cornerstoneMath = cornerstoneMath;

      cornerstoneTools.init({
        showSVGCursors: true,
      });

      let allSeries = {};
      let currentSeriesId = null;
      let currentImageIndex = 0;
      let loaded = false;

      // DOM elements
      const viewport = document.getElementById("viewport");
      const dicomImage = document.getElementById("dicomImage");
      const emptyState = document.getElementById("emptyState");
      const uploadArea = document.getElementById("uploadArea");
      const fileInput = document.getElementById("fileInput");
      const folderInput = document.getElementById("folderInput");
      const seriesContainer = document.getElementById("seriesContainer");
      const loadingOverlay = document.getElementById("loadingOverlay");
      const statusText = document.getElementById("statusText");
      const loadingText = document.getElementById("loadingText");
      let currentLayout = "1x1"; // default

      // Drag and drop functionality
      uploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadArea.classList.add("dragover");
      });

      uploadArea.addEventListener("dragleave", (e) => {
        e.preventDefault();
        uploadArea.classList.remove("dragover");
      });

      uploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadArea.classList.remove("dragover");
        handleFileUpload(e.dataTransfer.files);
      });

      uploadArea.addEventListener("click", () => {
        fileInput.click();
      });

      fileInput.addEventListener("change", (e) => {
        if (e.target.files.length > 0) {
          handleFileUpload(e.target.files);
          e.target.value = "";
        }
      });

      folderInput.addEventListener("change", (e) => {
        if (e.target.files.length > 0) {
          handleFileUpload(e.target.files);
          e.target.value = "";
        }
      });

      // Dropdown functionality
      document
        .getElementById("annotationTool")
        .addEventListener("click", (e) => {
          e.stopPropagation();
          toggleDropdown("annotationDropdown");
        });

      document.getElementById("layoutTool").addEventListener("click", (e) => {
        e.stopPropagation();
        toggleDropdown("layoutDropdown");
      });

      document.addEventListener("click", () => {
        closeAllDropdowns();
      });

      function toggleDropdown(dropdownId) {
        closeAllDropdowns();
        document.getElementById(dropdownId).classList.add("show");
      }

      function closeAllDropdowns() {
        document.querySelectorAll(".tool-dropdown").forEach((dropdown) => {
          dropdown.classList.remove("show");
        });
      }

      // File upload handling with proper series grouping
      function handleFileUpload(files) {
        //  console.log('Files received:', files.length);
        showLoading(true);
        updateStatus(`Processing ${files.length} files...`);

        const dicomFiles = Array.from(files).filter((file) => {
          const name = file.name.toLowerCase();
          return (
            name.endsWith(".dcm") ||
            name.endsWith(".dicom") ||
            name.includes("dicom") ||
            file.type === "application/dicom" ||
            file.type === "" ||
            file.size > 1024
          );
        });

        //  console.log('DICOM files found:', dicomFiles.length);

        if (dicomFiles.length === 0) {
          showError(
            `No DICOM files found in ${files.length} uploaded files. Please ensure files have .dcm extension or contain DICOM data.`
          );
          showLoading(false);
          return;
        }

        showSuccess(
          `Found ${dicomFiles.length} potential DICOM files. Processing...`
        );
        processDicomFiles(dicomFiles);
      }

      function processDicomFiles(files) {
        const tempSeries = {};
        let processedFiles = 0;
        let validFiles = 0;

        loadingText.textContent = `Processing DICOM files... (0/${files.length})`;

        files.forEach((file, index) => {
          const reader = new FileReader();
          reader.onload = function (e) {
            try {
              const arrayBuffer = e.target.result;
              const byteArray = new Uint8Array(arrayBuffer);

              // Try to parse DICOM header
              let dataSet;
              try {
                dataSet = dicomParser.parseDicom(byteArray);
              } catch (parseError) {
                console.warn(
                  "DICOM parse error for file:",
                  file.name,
                  parseError
                );
                // Skip this file
                processedFiles++;
                updateProgress((processedFiles / files.length) * 100);
                loadingText.textContent = `Processing DICOM files... (${processedFiles}/${files.length})`;

                if (processedFiles === files.length) {
                  finalizeSeries(tempSeries, validFiles);
                }
                return;
              }

              // Add file to cornerstone file manager
              const imageId =
                cornerstoneWADOImageLoader.wadouri.fileManager.add(file);
              // console.log('Added file to manager:', file.name, 'imageId:', imageId);

              // Extract DICOM metadata for series grouping
              const seriesInstanceUID =
                getMetadataValue(dataSet, "x0020000e") ||
                `unknown_series_${Math.random().toString(36).substr(2, 9)}`;
              const studyInstanceUID =
                getMetadataValue(dataSet, "x0020000d") || "unknown_study";
              const patientName =
                getMetadataValue(dataSet, "x00100010") || "Unknown Patient";
              const studyDescription =
                getMetadataValue(dataSet, "x00081030") || "Unknown Study";
              const seriesDescription =
                getMetadataValue(dataSet, "x0008103e") ||
                `Series ${getMetadataValue(dataSet, "x00200011") || "Unknown"}`;
              const seriesNumber =
                getMetadataValue(dataSet, "x00200011") || "0";
              const instanceNumber = parseInt(
                getMetadataValue(dataSet, "x00200013") || index + 1
              );
              const studyDate = getMetadataValue(dataSet, "x00080020") || "";
              const studyTime = getMetadataValue(dataSet, "x00080030") || "";
              const modality = getMetadataValue(dataSet, "x00080060") || "UN";

              // Create series key for grouping
              const seriesKey = `${studyInstanceUID}_${seriesInstanceUID}`;

              if (!tempSeries[seriesKey]) {
                tempSeries[seriesKey] = {
                  seriesInstanceUID,
                  studyInstanceUID,
                  patientName,
                  studyDescription,
                  seriesDescription,
                  seriesNumber,
                  studyDate: formatDate(studyDate),
                  studyTime: formatTime(studyTime),
                  modality,
                  images: [],
                };
              }

              tempSeries[seriesKey].images.push({
                imageId,
                instanceNumber,
                fileName: file.name,
                patientName,
                studyDescription,
                seriesDescription,
                studyDate: formatDate(studyDate),
                studyTime: formatTime(studyTime),
                modality,
              });

              validFiles++;
              processedFiles++;
              updateProgress((processedFiles / files.length) * 100);
              loadingText.textContent = `Processing DICOM files... (${processedFiles}/${files.length})`;

              if (processedFiles === files.length) {
                finalizeSeries(tempSeries, validFiles);
              }
            } catch (error) {
              console.error("Error processing file:", file.name, error);
              processedFiles++;
              updateProgress((processedFiles / files.length) * 100);
              loadingText.textContent = `Processing DICOM files... (${processedFiles}/${files.length}) - Error: ${file.name}`;

              if (processedFiles === files.length) {
                finalizeSeries(tempSeries, validFiles);
              }
            }
          };
          reader.readAsArrayBuffer(file);
        });
      }

      function finalizeSeries(tempSeries, validFiles) {
        if (validFiles === 0) {
          showError("No valid DICOM images found");
          showLoading(false);
          return;
        }

        // Sort images within each series by instance number
        Object.values(tempSeries).forEach((series) => {
          series.images.sort((a, b) => a.instanceNumber - b.instanceNumber);
        });

        // Merge with existing series
        allSeries = { ...allSeries, ...tempSeries };

        updateStatus(
          `Loaded ${validFiles} DICOM images in ${
            Object.keys(tempSeries).length
          } series`
        );
        createSeriesUI();

        // Load first series if none is currently selected
        if (!currentSeriesId && Object.keys(allSeries).length > 0) {
          const firstSeriesKey = Object.keys(allSeries)[0];
          selectSeries(firstSeriesKey, 0);
        }

        showSuccess(
          `Successfully loaded ${validFiles} DICOM images organized in ${
            Object.keys(tempSeries).length
          } series`
        );
        showLoading(false);
      }

      function createSeriesUI() {
        seriesContainer.innerHTML = "";

        Object.entries(allSeries).forEach(([seriesKey, series]) => {
          const seriesItem = document.createElement("div");
          seriesItem.className = "series-item";
          seriesItem.id = `series_${seriesKey}`;

          const seriesHeader = document.createElement("div");
          seriesHeader.className = "series-header";
          seriesHeader.onclick = () => toggleSeries(seriesKey);

          seriesHeader.innerHTML = `
                    <div>
                        <div class="series-title">${series.seriesDescription}</div>
                        <div class="series-info">${series.modality} • ${series.patientName}</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="series-count">${series.images.length}</div>
                        <i class="fas fa-chevron-down expand-icon"></i>
                    </div>
                `;

          const thumbnailsGrid = document.createElement("div");
          thumbnailsGrid.className = "thumbnails-grid";
          thumbnailsGrid.id = `thumbnails_${seriesKey}`;

          series.images.forEach((image, index) => {
            const thumbnail = document.createElement("div");
            thumbnail.className = "thumbnail";
            thumbnail.onclick = () => selectSeries(seriesKey, index);

            const loadingDiv = document.createElement("div");
            loadingDiv.className = "thumbnail-loading";
            loadingDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            thumbnail.appendChild(loadingDiv);

            const info = document.createElement("div");
            info.className = "thumbnail-info";
            info.textContent = `${index + 1}`;
            thumbnail.appendChild(info);

            thumbnailsGrid.appendChild(thumbnail);

            // Load thumbnail asynchronously with delay to prevent overwhelming
            setTimeout(() => {
              loadThumbnailImage(image.imageId, thumbnail, loadingDiv, index);
            }, index * 100 + Math.random() * 50); // Stagger loading with some randomness
          });

          seriesItem.appendChild(seriesHeader);
          seriesItem.appendChild(thumbnailsGrid);
          seriesContainer.appendChild(seriesItem);
        });
      }

      function toggleSeries(seriesKey) {
        const seriesItem = document.getElementById(`series_${seriesKey}`);
        seriesItem.classList.toggle("series-collapsed");
      }

      function selectSeries(seriesKey, imageIndex = 0) {
        if (!allSeries[seriesKey]) return;

        //  console.log('Selecting series:', seriesKey, 'image:', imageIndex);

        // Update active series
        document
          .querySelectorAll(".series-item")
          .forEach((item) => item.classList.remove("active"));
        const seriesElement = document.getElementById(`series_${seriesKey}`);
        if (seriesElement) {
          seriesElement.classList.add("active");
          // Expand the series if collapsed
          seriesElement.classList.remove("series-collapsed");
        }

        // Update active thumbnail
        document
          .querySelectorAll(".thumbnail")
          .forEach((thumb) => thumb.classList.remove("active"));
        const thumbnailsGrid = document.getElementById(
          `thumbnails_${seriesKey}`
        );
        if (thumbnailsGrid) {
          const thumbnails = thumbnailsGrid.querySelectorAll(".thumbnail");
          if (thumbnails[imageIndex]) {
            thumbnails[imageIndex].classList.add("active");
          }
        }

        currentSeriesId = seriesKey;
        currentImageIndex = imageIndex;

        const series = allSeries[seriesKey];
        const image = series.images[imageIndex];

        // console.log('Loading image:', image.imageId);

        // Enable cornerstone if not already enabled
        try {
          if (!loaded) {
            cornerstone.enable(dicomImage);
            loaded = true;
            // console.log('Cornerstone enabled on main viewport');
          }

          // Show loading state
          updateStatus("Loading image...");

          // Load and display image
          cornerstone
            .loadImage(image.imageId)
            .then(function (cornerstoneImage) {
              //   console.log('Image loaded successfully:', cornerstoneImage);

              try {
                const viewport = cornerstone.getDefaultViewportForImage(
                  dicomImage,
                  cornerstoneImage
                );

                // Apply appropriate windowing
                if (
                  cornerstoneImage.windowWidth &&
                  cornerstoneImage.windowCenter
                ) {
                  viewport.voi = {
                    windowWidth: cornerstoneImage.windowWidth,
                    windowCenter: cornerstoneImage.windowCenter,
                  };
                } else {
                  // Auto calculate window/level
                  const range =
                    cornerstoneImage.maxPixelValue -
                    cornerstoneImage.minPixelValue;
                  viewport.voi = {
                    windowWidth: range,
                    windowCenter: cornerstoneImage.minPixelValue + range / 2,
                  };
                }

                cornerstone.displayImage(
                  dicomImage,
                  cornerstoneImage,
                  viewport
                );

                showViewer();
                updateImageInfo();
                setupTools();
                updateStatus("Image loaded successfully");
              } catch (displayError) {
                console.error("Error displaying image:", displayError);
                showError("Error displaying image: " + displayError.message);
              }
            })
            .catch(function (error) {
              console.error("Error loading DICOM image:", error);
              showError("Error loading DICOM image: " + error.message);
              updateStatus("Error loading image");
            });
        } catch (enableError) {
          console.error("Error enabling cornerstone:", enableError);
          showError("Error initializing viewer: " + enableError.message);
        }
      }

      function loadThumbnailImage(
        imageId,
        thumbnailContainer,
        loadingDiv,
        index
      ) {
        // Use HTML5 Canvas with 2D context instead of cornerstone for better performance
        const canvas = document.createElement("canvas");
        canvas.className = "thumbnail-image";
        canvas.width = 76;
        canvas.height = 76;
        canvas.style.display = "none";

        //console.log('Loading thumbnail for:', imageId);

        // Load the DICOM image using cornerstone but render differently
        cornerstone
          .loadImage(imageId)
          .then(function (image) {
            try {
              // Create a temporary div element for cornerstone
              const tempDiv = document.createElement("div");
              tempDiv.style.width = "76px";
              tempDiv.style.height = "76px";
              tempDiv.style.position = "absolute";
              tempDiv.style.left = "-9999px"; // Hide off-screen
              document.body.appendChild(tempDiv);

              // Enable cornerstone on temp div
              cornerstone.enable(tempDiv);

              // Calculate viewport for thumbnail
              const viewport = cornerstone.getDefaultViewportForImage(
                tempDiv,
                image
              );
              const scaleX = 76 / image.width;
              const scaleY = 76 / image.height;
              viewport.scale = Math.min(scaleX, scaleY) * 0.85;
              viewport.translation = { x: 0, y: 0 };

              // Set windowing
              if (image.windowWidth && image.windowCenter) {
                viewport.voi = {
                  windowWidth: image.windowWidth,
                  windowCenter: image.windowCenter,
                };
              } else {
                const range = image.maxPixelValue - image.minPixelValue;
                viewport.voi = {
                  windowWidth: range * 0.8,
                  windowCenter: image.minPixelValue + range / 2,
                };
              }

              // Display on temp div
              cornerstone.displayImage(tempDiv, image, viewport);

              // Get the canvas from cornerstone and copy it
              const cornerstoneCanvas = tempDiv.querySelector("canvas");
              if (cornerstoneCanvas) {
                const ctx = canvas.getContext("2d");
                ctx.drawImage(cornerstoneCanvas, 0, 0, 76, 76);
              }

              // Cleanup temp div
              cornerstone.disable(tempDiv);
              document.body.removeChild(tempDiv);

              // Replace loading indicator with canvas
              if (loadingDiv && loadingDiv.parentNode) {
                loadingDiv.remove();
              }
              canvas.style.display = "block";

              const infoElement =
                thumbnailContainer.querySelector(".thumbnail-info");
              if (infoElement) {
                thumbnailContainer.insertBefore(canvas, infoElement);
              } else {
                thumbnailContainer.appendChild(canvas);
              }
            } catch (error) {
              console.error("Error creating thumbnail:", error);
              showThumbnailError(loadingDiv, "Render error");
            }
          })
          .catch(function (error) {
            console.error("Error loading thumbnail image:", error);
            showThumbnailError(loadingDiv, "Load error");
          });
      }

      function showThumbnailError(loadingDiv, errorType = "Error") {
        if (loadingDiv && loadingDiv.parentNode) {
          loadingDiv.innerHTML =
            '<i class="fas fa-exclamation-triangle" title="' +
            errorType +
            '"></i>';
          loadingDiv.style.color = "#dc2626";
          loadingDiv.style.fontSize = "10px";
        }
      }

      function setupTools() {
        const series = allSeries[currentSeriesId];
        if (!series || series.images.length <= 1) return;

        const element = dicomImage;
        const StackScrollMouseWheelTool =
          cornerstoneTools.StackScrollMouseWheelTool;

        const stack = {
          currentImageIdIndex: currentImageIndex,
          imageIds: series.images.map((img) => img.imageId),
        };

        cornerstoneTools.addStackStateManager(element, ["stack"]);
        cornerstoneTools.addToolState(element, "stack", stack);
        cornerstoneTools.addTool(StackScrollMouseWheelTool);
        cornerstoneTools.setToolActive("StackScrollMouseWheel", {});

        // element.addEventListener('wheel', function(e) {
        //     e.preventDefault();
        //     const delta = e.deltaY > 0 ? 1 : -1;
        //     changeImage(delta);
        // });

        let scrollAccumulator = 0;
        const SCROLL_THRESHOLD = 100;

        element.addEventListener("wheel", function (event) {
          event.preventDefault();

          scrollAccumulator += event.deltaY;

          if (scrollAccumulator >= SCROLL_THRESHOLD) {
            changeImage(1);
            scrollAccumulator = 0;
            scrollAccumulator = 0;
          } else if (scrollAccumulator <= -SCROLL_THRESHOLD) {
            scrollAccumulator = 0;
          }
        });

        activateTool("wwwc");
      }

      function changeImage(direction) {
        const series = allSeries[currentSeriesId];
        if (!series) return;

        const newIndex = Math.max(
          0,
          Math.min(series.images.length - 1, currentImageIndex + direction)
        );
        if (newIndex !== currentImageIndex) {
          selectSeries(currentSeriesId, newIndex);
        }
      }

      function showViewer() {
        emptyState.style.display = "none";
        dicomImage.style.display = "block";
      }

      function updateImageInfo() {
        if (!currentSeriesId || !allSeries[currentSeriesId]) return;

        const series = allSeries[currentSeriesId];
        const currentImage = series.images[currentImageIndex];

        document.getElementById(
          "topLeft"
        ).innerHTML = `Patient: ${series.patientName}<br>Study: ${series.studyDescription}`;

        document.getElementById(
          "topRight"
        ).innerHTML = `Date: ${series.studyDate}<br>Time: ${series.studyTime}`;

        document.getElementById("bottomLeft").innerHTML = `Series: ${
          series.seriesDescription
        }<br>Image: ${currentImageIndex + 1}/${series.images.length}`;

        if (loaded) {
          const viewport = cornerstone.getViewport(dicomImage);
          document.getElementById(
            "bottomRight"
          ).innerHTML = `WW/WC: ${Math.round(
            viewport.voi.windowWidth
          )}/${Math.round(
            viewport.voi.windowCenter
          )}<br>Zoom: ${viewport.scale.toFixed(1)}x`;
        }
      }

      function getMetadataValue(dataSet, tag) {
        try {
          const element = dataSet.elements[tag];
          if (element) {
            return dataSet.string(tag);
          }
          return null;
        } catch (error) {
          return null;
        }
      }

      function formatDate(dateStr) {
        if (!dateStr || dateStr.length < 8) return "Unknown";
        const year = dateStr.substring(0, 4);
        const month = dateStr.substring(4, 6);
        const day = dateStr.substring(6, 8);
        return `${day}/${month}/${year}`;
      }

      function formatTime(timeStr) {
        if (!timeStr || timeStr.length < 6) return "Unknown";
        const hour = timeStr.substring(0, 2);
        const minute = timeStr.substring(2, 4);
        const second = timeStr.substring(4, 6);
        return `${hour}:${minute}:${second}`;
      }

      function updateStatus(message) {
        statusText.textContent = message;
      }

      // Tool activation
      function activateTool(toolName) {
        if (!loaded) return;

        document
          .querySelectorAll(".tool-btn")
          .forEach((btn) => btn.classList.remove("active"));

        const element = dicomImage;

        cornerstoneTools.setToolPassive("Wwwc");
        cornerstoneTools.setToolPassive("Zoom");
        cornerstoneTools.setToolPassive("Pan");
        cornerstoneTools.setToolPassive("Magnify");

        switch (toolName) {
          case "wwwc":
            const WwwcTool = cornerstoneTools.WwwcTool;
            cornerstoneTools.addTool(WwwcTool);
            cornerstoneTools.setToolActive("Wwwc", { mouseButtonMask: 1 });
            document.getElementById("wwwcTool").classList.add("active");
            break;

          case "zoom":
            const ZoomTool = cornerstoneTools.ZoomTool;
            cornerstoneTools.addTool(ZoomTool, {
              configuration: {
                invert: false,
                preventZoomOutsideImage: false,
                minScale: 0.1,
                maxScale: 20.0,
              },
            });
            cornerstoneTools.setToolActive("Zoom", { mouseButtonMask: 1 });
            break;

          case "pan":
            const PanTool = cornerstoneTools.PanTool;
            cornerstoneTools.addTool(PanTool);
            cornerstoneTools.setToolActive("Pan", { mouseButtonMask: 1 });
            break;

          case "magnify":
            const MagnifyTool = cornerstoneTools.MagnifyTool;
            cornerstoneTools.addTool(MagnifyTool);
            cornerstoneTools.setToolActive("Magnify", { mouseButtonMask: 1 });
            break;

          case "bidirectional":
            const BidirectionalTool = cornerstoneTools.BidirectionalTool;
            cornerstoneTools.addTool(BidirectionalTool);
            cornerstoneTools.setToolActive("Bidirectional", {
              mouseButtonMask: 1,
            });
            break;

          case "ellipse":
            const EllipticalRoiTool = cornerstoneTools.EllipticalRoiTool;
            cornerstoneTools.addTool(EllipticalRoiTool);
            cornerstoneTools.setToolActive("EllipticalRoi", {
              mouseButtonMask: 1,
            });
            break;

          case "rectangle":
            const RectangleRoiTool = cornerstoneTools.RectangleRoiTool;
            cornerstoneTools.addTool(RectangleRoiTool);
            cornerstoneTools.setToolActive("RectangleRoi", {
              mouseButtonMask: 1,
            });
            break;

          case "freehand":
            const FreehandRoiTool = cornerstoneTools.FreehandRoiTool;
            cornerstoneTools.addTool(FreehandRoiTool);
            cornerstoneTools.setToolActive("FreehandRoi", {
              mouseButtonMask: 1,
            });
            break;

          case "length":
            const LengthTool = cornerstoneTools.LengthTool;
            cornerstoneTools.addTool(LengthTool);
            cornerstoneTools.setToolActive("Length", { mouseButtonMask: 1 });
            break;

          case "angle":
            const AngleTool = cornerstoneTools.AngleTool;
            cornerstoneTools.addTool(AngleTool);
            cornerstoneTools.setToolActive("Angle", { mouseButtonMask: 1 });
            break;

          case "probe":
            const ProbeTool = cornerstoneTools.ProbeTool;
            cornerstoneTools.addTool(ProbeTool);
            cornerstoneTools.setToolActive("Probe", { mouseButtonMask: 1 });
            break;

          case "arrow":
            const ArrowAnnotateTool = cornerstoneTools.ArrowAnnotateTool;
            cornerstoneTools.addTool(ArrowAnnotateTool);
            cornerstoneTools.setToolActive("ArrowAnnotate", {
              mouseButtonMask: 1,
            });
            break;

          case "eraser":
            const EraserTool = cornerstoneTools.EraserTool;
            cornerstoneTools.addTool(EraserTool);
            cornerstoneTools.setToolActive("Eraser", { mouseButtonMask: 1 });
            break;
        }

        closeAllDropdowns();
      }

      // Window/Level presets
      function applyPreset(presetName) {
        if (!loaded) return;

        const element = dicomImage;
        const viewport = cornerstone.getViewport(element);

        switch (presetName) {
          case "soft":
            viewport.voi.windowWidth = 400;
            viewport.voi.windowCenter = 20;
            break;
          case "bone":
            viewport.voi.windowWidth = 2000;
            viewport.voi.windowCenter = 300;
            break;
          case "lung":
            viewport.voi.windowWidth = 1500;
            viewport.voi.windowCenter = -600;
            break;
          case "brain":
            viewport.voi.windowWidth = 80;
            viewport.voi.windowCenter = 40;
            break;
        }

        cornerstone.setViewport(element, viewport);
        updateImageInfo();
      }

      function invertImage() {
        if (!loaded) return;

        const element = dicomImage;
        const viewport = cornerstone.getViewport(element);
        viewport.invert = !viewport.invert;
        cornerstone.setViewport(element, viewport);
      }

      function resetViewport() {
        if (!loaded) return;

        const element = dicomImage;
        cornerstone.reset(element);
        updateImageInfo();
      }

      // function changeLayout(layout) {
      //    // console.log('Layout changed to:', layout);
      //     closeAllDropdowns();
      // }

      function changeLayout(layout) {
        closeAllDropdowns();

        // Clear existing layout
        const viewportContainer = document.getElementById("viewportContainer"); // You need to wrap your current #dicomImage in a container
        viewportContainer.innerHTML = "";

        // Determine rows/cols
        let rows = 1,
          cols = 1;
        switch (layout) {
          case "1x1":
            rows = 1;
            cols = 1;
            break;
          case "1x2":
            rows = 1;
            cols = 2;
            break;
          case "2x1":
            rows = 2;
            cols = 1;
            break;
          case "2x2":
            rows = 2;
            cols = 2;
            break;
        }

        // Create grid style
        viewportContainer.style.display = "grid";
        viewportContainer.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
        viewportContainer.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
        viewportContainer.style.gap = "2px";

        // Add viewports
        let index = 0;
        const series = allSeries[currentSeriesId];
        if (!series) return;

        for (let r = 0; r < rows; r++) {
          for (let c = 0; c < cols; c++) {
            const vp = document.createElement("div");
            vp.className = "dicom-viewport";
            vp.style.width = "100%";
            vp.style.height = "100%";
            viewportContainer.appendChild(vp);

            cornerstone.enable(vp);

            if (series.images[index]) {
              cornerstone
                .loadImage(series.images[index].imageId)
                .then((img) => {
                  cornerstone.displayImage(vp, img);
                });
              index++;
            }
          }
        }
      }

      function showLoading(show) {
        loadingOverlay.style.display = show ? "flex" : "none";
      }

      function updateProgress(percent) {
        const progressFill = document.getElementById("progressFill");
        const uploadProgress = document.getElementById("uploadProgress");

        if (percent > 0) {
          uploadProgress.style.display = "block";
          progressFill.style.width = percent + "%";
        } else {
          uploadProgress.style.display = "none";
        }
      }

      function showError(message) {
        const errorDiv = document.getElementById("errorMessage");
        errorDiv.textContent = message;
        errorDiv.style.display = "block";
        setTimeout(() => {
          errorDiv.style.display = "none";
        }, 5000);
      }

      function showSuccess(message) {
        const successDiv = document.getElementById("successMessage");
        successDiv.textContent = message;
        successDiv.style.display = "block";
        setTimeout(() => {
          successDiv.style.display = "none";
        }, 3000);
      }

      // Keyboard shortcuts
      document.addEventListener("keydown", function (e) {
        if (!loaded) return;

        switch (e.keyCode) {
          case 37: // Left arrow
            e.preventDefault();
            changeImage(-1);
            break;
          case 39: // Right arrow
            e.preventDefault();
            changeImage(1);
            break;
          case 38: // Up arrow
            e.preventDefault();
            changeImage(1);
            break;
          case 40: // Down arrow
            e.preventDefault();
            changeImage(-1);
            break;
          case 82: // R key - Reset
            if (e.ctrlKey) {
              e.preventDefault();
              resetViewport();
            }
            break;
          case 73: // I key - Invert
            if (e.ctrlKey) {
              e.preventDefault();
              invertImage();
            }
            break;
        }
      });

      // Viewport event listeners
      function setupViewportListeners() {
        const element = dicomImage;

        element.addEventListener("cornerstoneimagerendered", function (e) {
          updateImageInfo();
        });

        element.addEventListener("cornerstonenewimage", function (e) {
          updateImageInfo();
        });
      }

      window.addEventListener("load", function () {
        setTimeout(setupViewportListeners, 1000);
      });

      // Load demo data
      function loadSampleData() {
        showLoading(true);
        updateStatus("Loading demo data...");

        const sampleData = {
          demo_series_1: {
            seriesInstanceUID: "1.2.3.4.5.6.7.8.9.1",
            studyInstanceUID: "1.2.3.4.5.6.7.8.9",
            patientName: "Demo Patient",
            studyDescription: "PT/CT Study Demo",
            seriesDescription: "CT Series",
            seriesNumber: "1",
            studyDate: "15/01/2024",
            studyTime: "14:30:25",
            modality: "CT",
            images: [
              {
                imageId:
                  "dicomweb://s3.amazonaws.com/lury/PTCTStudy/1.3.6.1.4.1.25403.52237031786.3872.20100510032220.7.dcm",
                instanceNumber: 1,
                fileName: "demo1.dcm",
                patientName: "Demo Patient",
                studyDescription: "PT/CT Study Demo",
                seriesDescription: "CT Series",
                studyDate: "15/01/2024",
                studyTime: "14:30:25",
                modality: "CT",
              },
              {
                imageId:
                  "dicomweb://s3.amazonaws.com/lury/PTCTStudy/1.3.6.1.4.1.25403.52237031786.3872.20100510032220.8.dcm",
                instanceNumber: 2,
                fileName: "demo2.dcm",
                patientName: "Demo Patient",
                studyDescription: "PT/CT Study Demo",
                seriesDescription: "CT Series",
                studyDate: "15/01/2024",
                studyTime: "14:30:25",
                modality: "CT",
              },
              {
                imageId:
                  "dicomweb://s3.amazonaws.com/lury/PTCTStudy/1.3.6.1.4.1.25403.52237031786.3872.20100510032220.9.dcm",
                instanceNumber: 3,
                fileName: "demo3.dcm",
                patientName: "Demo Patient",
                studyDescription: "PT/CT Study Demo",
                seriesDescription: "CT Series",
                studyDate: "15/01/2024",
                studyTime: "14:30:25",
                modality: "CT",
              },
            ],
          },
        };

        setTimeout(() => {
          allSeries = sampleData;
          createSeriesUI();
          selectSeries("demo_series_1", 0);
          showSuccess("Demo data loaded successfully");
          showLoading(false);
        }, 1000);
      }

      // Add demo button
      const demoButton = document.createElement("button");
      demoButton.className = "upload-btn";
      demoButton.innerHTML = '<i class="fas fa-play"></i> Load Demo';
      demoButton.onclick = loadSampleData;
      demoButton.style.marginTop = "10px";
      uploadArea.appendChild(demoButton);
    </script>
  </body>
</html>
